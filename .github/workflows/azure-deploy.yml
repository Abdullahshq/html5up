name: Create and Deploy to Azure Web App with PHP
on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      webapp_name:
        description: 'Web app name'
        required: true
        type: string
      resource_group:
        description: 'Resource group name'
        required: true
        type: string
      location:
        description: 'Azure region'
        required: false
        default: 'eastus'
        type: string
      php_version:
        description: 'PHP version'
        required: false
        default: '8.0'
        type: string
      sku:
        description: 'App Service plan SKU'
        required: false
        default: 'B1'
        type: string

jobs:
  deploy-to-azure:
    name: Create and Deploy to Azure
    runs-on: ubuntu-latest
    outputs:
      webapp_url: ${{ steps.create-webapp.outputs.webapp-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "${{ github.event.inputs.php_version || '8.0' }}"
          extensions: mbstring, intl, gd, xml, zip
          
      - name: Install dependencies
        run: |
          if [ -f composer.json ]; then
            composer install --no-interaction --prefer-dist --optimize-autoloader
          fi
          
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Validate webapp name
        run: |
          WEBAPP_NAME="${{ github.event.inputs.webapp_name }}"
          if ! [[ $WEBAPP_NAME =~ ^[a-z0-9\-]+$ ]]; then
            echo "::error::Web app name must contain only lowercase letters, numbers, and hyphens"
            exit 1
          fi
      
      - name: Create Azure resources
        id: create-webapp
        run: |
          # Set variables
          RG="${{ github.event.inputs.resource_group }}"
          LOCATION="${{ github.event.inputs.location || 'eastus' }}"
          WEBAPP="${{ github.event.inputs.webapp_name }}"
          PHP_VER="${{ github.event.inputs.php_version || '8.0' }}"
          SKU="${{ github.event.inputs.sku || 'B1' }}"
          APP_PLAN="${WEBAPP}-plan"
          
            # Create app service plan if not exists
            if ! az appservice plan show --name "$APP_PLAN" --resource-group "$RG" &>/dev/null; then
            az appservice plan create --name "$APP_PLAN" --resource-group "$RG" \
              --location "$LOCATION" --sku "$SKU" --is-linux
            fi

            # Create web app if not exists
            if ! az webapp show --name "$WEBAPP" --resource-group "$RG" &>/dev/null; then
            az webapp create --name "$WEBAPP" --resource-group "$RG" \
              --plan "$APP_PLAN" --runtime "PHP|$PHP_VER"
            fi

            # Configure web app
            az webapp config set --name "$WEBAPP" --resource-group "$RG" --php-version "$PHP_VER"
            az webapp config appsettings set --name "$WEBAPP" --resource-group "$RG" \
            --settings WEBSITE_STARTUP_COMMAND="php -S 0.0.0.0:8080"

            # Set output
            echo "webapp-url=https://${WEBAPP}.azurewebsites.net" >> $GITHUB_OUTPUT
          
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ github.event.inputs.webapp_name }}
          package: .
          
      - name: Verify and Report
        run: |
          WEBAPP_URL="https://${{ github.event.inputs.webapp_name }}.azurewebsites.net"
          echo "Checking deployment at $WEBAPP_URL"
          sleep 20
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $WEBAPP_URL)
          echo "HTTP Status: $HTTP_STATUS"
          
          # Create deployment report
          echo "## ðŸš€ Azure Web App Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "* **App:** ${{ github.event.inputs.webapp_name }}" >> $GITHUB_STEP_SUMMARY
          echo "* **Resource Group:** ${{ github.event.inputs.resource_group }}" >> $GITHUB_STEP_SUMMARY
          echo "* **PHP Version:** ${{ github.event.inputs.php_version || '8.0' }}" >> $GITHUB_STEP_SUMMARY
          echo "* **URL:** $WEBAPP_URL" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true